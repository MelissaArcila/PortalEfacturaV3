<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HU004 - Crear Empresa - Portal Unificado Efactura</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', Arial, sans-serif; background-color: #FAFAFA; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); padding: 40px; }
        .header h1 { font-size: 2rem; font-weight: 600; color: #212121; margin-bottom: 8px; }
        .header p { font-size: 14px; color: #757575; margin-bottom: 32px; }
        .section { margin-bottom: 40px; padding-bottom: 32px; border-bottom: 1px solid #E0E0E0; }
        .section:last-of-type { border-bottom: none; }
        .section-title { font-size: 1.25rem; font-weight: 600; color: #4A5A9E; margin-bottom: 24px; display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; transition: color 0.3s; }
        .section-title:hover { color: #D4145A; }
        .section-title .collapse-icon { margin-left: auto; transition: transform 0.3s; }
        .section-title .collapse-icon.collapsed { transform: rotate(-90deg); }
        .section-content { overflow: hidden; transition: max-height 0.3s ease-out; }
        .section-content.collapsed { max-height: 0 !important; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-size: 14px; font-weight: 500; color: #424242; margin-bottom: 8px; }
        label.required::after { content: ' *'; color: #F44336; }
        input, select, textarea { padding: 12px; font-size: 14px; border: 1px solid #BDBDBD; border-radius: 4px; font-family: 'Roboto', Arial, sans-serif; transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #4A5A9E; border-width: 2px; padding: 11px; }
        input:disabled, select:disabled { background-color: #F5F5F5; color: #9E9E9E; cursor: not-allowed; }
        input.error, select.error { border-color: #F44336; }
        input.success { border-color: #4CAF50; }
        .helper-text { font-size: 12px; margin-top: 4px; }
        .helper-text.error { color: #F44336; }
        .helper-text.success { color: #4CAF50; display: flex; align-items: center; gap: 4px; }
        .character-counter { font-size: 12px; color: #757575; margin-top: 4px; }
        .validation-icon { width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-left: 8px; }
        .validation-icon.success { background-color: #E8F5E9; color: #4CAF50; }
        .validation-icon.error { background-color: #FFEBEE; color: #F44336; }
        .btn { padding: 12px 24px; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-radius: 8px; cursor: pointer; transition: all 0.3s; border: none; font-family: 'Roboto', Arial, sans-serif; }
        .btn-primary { background: linear-gradient(135deg, #4A5A9E 0%, #D4145A 100%); color: white; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary:hover:not(:disabled) { box-shadow: 0 6px 16px rgba(74, 90, 158, 0.3); transform: translateY(-2px); }
        .btn-secondary { background: white; color: #4A5A9E; border: 1px solid #4A5A9E; }
        .btn-small { padding: 8px 16px; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        th { background-color: #F5F5F5; padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #424242; }
        td { padding: 12px; font-size: 14px; color: #616161; border-top: 1px solid #F5F5F5; }
        .icon-btn { background: transparent; border: none; cursor: pointer; padding: 4px; color: #F44336; }
        .button-group { display: flex; gap: 12px; margin-top: 32px; padding-top: 24px; border-top: 1px solid #E0E0E0; }

        /* Estilos del modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .modal-header { padding: 24px; border-bottom: 1px solid #E0E0E0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 1.5rem; color: #4A5A9E; display: flex; align-items: center; gap: 8px; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid #E0E0E0; display: flex; justify-content: flex-end; gap: 12px; }
        .close-modal { color: #9E9E9E; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s; }
        .close-modal:hover { color: #D4145A; }

        @media (max-width: 768px) { .container { padding: 24px; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Crear Nueva Empresa</h1>
            <p>Complete el formulario con los datos de la empresa. Los campos marcados con (*) son obligatorios.</p>
        </div>

        <form id="empresaForm">
            <!-- Sección 1: Datos de la Empresa -->
            <div class="section">
                <h2 class="section-title" onclick="toggleSection(this)">
                    <span class="material-icons">business</span>
                    Datos de la Empresa
                    <span class="material-icons collapse-icon">expand_more</span>
                </h2>

                <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="tipoId" class="required">Tipo de Identificación</label>
                        <select id="tipoId" required onchange="handleTipoIdChange()">
                            <option value="">Seleccione...</option>
                            <option value="11">Registro civil</option>
                            <option value="13">Cédula de ciudadanía</option>
                            <option value="31" selected>NIT</option>
                            <option value="41">Pasaporte</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="numeroId" class="required">Número de Identificación</label>
                        <input type="text" id="numeroId" placeholder="Solo números, máx 10 dígitos" maxlength="10" required
                            oninput="validateNumeroId()" onblur="checkUniqueness()" />
                        <div class="helper-text" id="numeroIdHelper"></div>
                    </div>
                    <div class="form-group">
                        <label for="dv">DV (Dígito de Verificación)</label>
                        <input type="text" id="dv" placeholder="0-9" maxlength="1" onblur="validateDV()" />
                        <div class="helper-text" id="dvHelper"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="nombreAbreviado">Nombre Abreviado</label>
                        <input type="text" id="nombreAbreviado" placeholder="Máx 50 caracteres" maxlength="50" oninput="updateCounter('nombreAbreviado', 50)" />
                        <div class="character-counter" id="nombreAbreviadoCounter">0/50 caracteres</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" id="razonSocialGroup">
                        <label for="razonSocial" class="required">Razón Social</label>
                        <input type="text" id="razonSocial" placeholder="Ingrese la razón social de la empresa" />
                    </div>
                    <div class="form-group" id="nombresGroup" style="display:none;">
                        <label for="nombres" class="required">Nombres</label>
                        <input type="text" id="nombres" placeholder="Ingrese nombres" disabled />
                    </div>
                    <div class="form-group" id="apellidosGroup" style="display:none;">
                        <label for="apellidos" class="required">Apellidos</label>
                        <input type="text" id="apellidos" placeholder="Ingrese apellidos" disabled />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="tipoSociedad" class="required">Tipo de Sociedad</label>
                        <select id="tipoSociedad" required>
                            <option value="">Seleccione...</option>
                            <option value="4">Sociedad anónima</option>
                            <option value="10">Sociedad por acciones simplificada</option>
                            <option value="9">Sociedad limitada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tipoContribuyente" class="required">Tipo de Contribuyente</label>
                        <select id="tipoContribuyente" required>
                            <option value="">Seleccione...</option>
                            <option value="natural">Natural</option>
                            <option value="juridico">Jurídico</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="tipoRegimen" class="required">Tipo de Régimen</label>
                        <select id="tipoRegimen" required>
                            <option value="">Seleccione...</option>
                            <option value="NA">Ninguno</option>
                            <option value="49">Simplificado (No responsable de IVA)</option>
                            <option value="48">Común (Impuesto sobre las ventas)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="correoEmisor" class="required">Correo Electrónico Emisor</label>
                        <input type="email" id="correoEmisor" placeholder="empresa@dominio.com" required onblur="validateEmail()" />
                        <div class="helper-text" id="correoHelper"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label for="actividadEconomica">Actividad Económica (opcional)</label>
                        <textarea id="actividadEconomica" rows="3" placeholder="Máx 200 caracteres" maxlength="200" oninput="updateCounter('actividadEconomica', 200)"></textarea>
                        <div class="character-counter" id="actividadEconomicaCounter">0/200 caracteres</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Centros de Costos</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <input type="text" id="centroCostoInput" placeholder="Número de 5 dígitos" maxlength="5" style="flex: 1;" />
                        <button type="button" class="btn btn-secondary btn-small" onclick="addCentroCosto()">Agregar</button>
                    </div>
                    <table id="centrosCostosTable" style="display:none;">
                        <thead><tr><th>Centro de Costo</th><th>Acciones</th></tr></thead>
                        <tbody id="centrosCostosBody"></tbody>
                    </table>
                </div>
                </div>
            </div>

            <!-- Sección 2: Ubicación -->
            <div class="section">
                <h2 class="section-title" onclick="toggleSection(this)">
                    <span class="material-icons">location_on</span>
                    Ubicación
                    <span class="material-icons collapse-icon">expand_more</span>
                </h2>

                <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="pais" class="required">País</label>
                        <select id="pais" required onchange="handlePaisChange()">
                            <option value="">Seleccione...</option>
                            <option value="1">Colombia</option>
                            <option value="2">Argentina</option>
                            <option value="12">Estados Unidos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="departamento" id="departamentoLabel">Departamento</label>
                        <select id="departamento" disabled onchange="handleDepartamentoChange()">
                            <option value="">Seleccione...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ciudad" id="ciudadLabel">Ciudad</label>
                        <select id="ciudad" disabled>
                            <option value="">Seleccione...</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label for="direccionPrincipal" class="required">Dirección Principal</label>
                        <input type="text" id="direccionPrincipal" placeholder="Calle 100 # 20-30, Oficina 502" required />
                    </div>
                </div>
                </div>
            </div>

            <!-- Sección 3: Registro Mercantil -->
            <div class="section">
                <h2 class="section-title" onclick="toggleSection(this)">
                    <span class="material-icons">description</span>
                    Registro Mercantil
                    <span class="material-icons collapse-icon">expand_more</span>
                </h2>

                <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="matriculaMercantil" class="required">Matrícula Mercantil</label>
                        <input type="text" id="matriculaMercantil" placeholder="5-15 caracteres" maxlength="15" />
                    </div>
                    <div class="form-group">
                        <label for="nombreRegistro" class="required">Nombre en Registro</label>
                        <input type="text" id="nombreRegistro" placeholder="Nombre completo" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="paisRegistro" class="required">País</label>
                        <select id="paisRegistro" onchange="handlePaisRegistroChange()">
                            <option value="">Seleccione...</option>
                            <option value="1">Colombia</option>
                            <option value="2">Argentina</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="departamentoRegistro">Departamento</label>
                        <select id="departamentoRegistro" disabled onchange="handleDepartamentoRegistroChange()">
                            <option value="">Seleccione...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ciudadRegistro">Ciudad</label>
                        <select id="ciudadRegistro" disabled>
                            <option value="">Seleccione...</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label for="direccionRegistro" class="required">Dirección</label>
                        <input type="text" id="direccionRegistro" placeholder="Dirección completa" />
                    </div>
                </div>

                <button type="button" class="btn btn-secondary btn-small" onclick="addRegistroMercantil()">
                    <span class="material-icons" style="font-size: 16px;">add</span> Agregar Registro Mercantil
                </button>

                <table id="registrosMercantilesTable" style="display:none; margin-top: 16px;">
                    <thead><tr><th>Matrícula</th><th>Nombre</th><th>País</th><th>Dirección</th><th>Acciones</th></tr></thead>
                    <tbody id="registrosMercantilesBody"></tbody>
                </table>
                </div>
            </div>

            <!-- Sección 4: Configuración SCIM -->
            <div class="section">
                <h2 class="section-title" onclick="toggleSection(this)">
                    <span class="material-icons">security</span>
                    Configuración SCIM
                    <span class="material-icons collapse-icon">expand_more</span>
                </h2>

                <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="scimActivo" onchange="handleSCIMToggle()" style="width: 20px; height: 20px; cursor: pointer;" />
                            <span style="font-weight: 600;">Integración SCIM Activa</span>
                        </label>
                        <div class="helper-text">Active esta opción para habilitar la sincronización de usuarios mediante SCIM</div>
                    </div>
                </div>

                <div id="scimConfigSection" style="display: none;">
                    <!-- Endpoint SCIM -->
                    <div class="form-row">
                        <div class="form-group" style="grid-column: 1/-1;">
                            <label for="endpointSCIM" class="required">Endpoint SCIM de la Plataforma</label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="endpointSCIM" value="https://plataforma.com/scim/v2/{tenantId}/Users" readonly
                                    style="flex: 1; background-color: #F5F5F5;" />
                                <button type="button" class="btn btn-secondary btn-small" onclick="copyToClipboard('endpointSCIM')" title="Copiar al portapapeles">
                                    <span class="material-icons" style="font-size: 18px;">content_copy</span>
                                </button>
                            </div>
                            <div class="helper-text">Este endpoint será utilizado por su Identity Provider para sincronizar usuarios</div>
                        </div>
                    </div>

                    <!-- Bearer Token -->
                    <div class="form-row">
                        <div class="form-group" style="grid-column: 1/-1;">
                            <label for="bearerToken" class="required">Bearer Token SCIM</label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="password" id="bearerToken" value="" readonly
                                    style="flex: 1; background-color: #F5F5F5; font-family: monospace;" />
                                <button type="button" class="btn btn-secondary btn-small" onclick="toggleTokenVisibility()" title="Mostrar/Ocultar token">
                                    <span class="material-icons" style="font-size: 18px;" id="tokenVisibilityIcon">visibility</span>
                                </button>
                                <button type="button" class="btn btn-secondary btn-small" onclick="copyToClipboard('bearerToken')" title="Copiar al portapapeles">
                                    <span class="material-icons" style="font-size: 18px;">content_copy</span>
                                </button>
                                <button type="button" class="btn btn-secondary btn-small" onclick="regenerateToken()" title="Regenerar token">
                                    <span class="material-icons" style="font-size: 18px;">refresh</span>
                                </button>
                            </div>
                            <div class="helper-text" style="color: #F57C00; display: flex; align-items: center; gap: 4px;">
                                <span class="material-icons" style="font-size: 16px;">warning</span>
                                Guarde este token en un lugar seguro. Solo se muestra una vez en formato claro.
                            </div>
                        </div>
                    </div>

                    <!-- Fecha de Expiración -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fechaExpiracion">Fecha de Expiración del Token</label>
                            <input type="text" id="fechaExpiracion" value="" readonly style="background-color: #F5F5F5;" />
                            <div class="helper-text" id="expiracionHelper">El token expirará en 90 días</div>
                        </div>
                    </div>

                    <!-- URL del IdP SAML -->
                    <div class="form-row">
                        <div class="form-group" style="grid-column: 1/-1;">
                            <label for="urlIdpSAML" class="required">URL del Identity Provider (IdP) SAML</label>
                            <input type="url" id="urlIdpSAML" placeholder="https://adfs.empresa.com/adfs/ls"
                                pattern="https://.*" oninput="validateURL()" required />
                            <div class="helper-text" id="urlIdpHelper">Ingrese la URL HTTPS de su Identity Provider SAML</div>
                        </div>
                    </div>

                    <!-- Certificado SAML -->
                    <div class="form-row">
                        <div class="form-group" style="grid-column: 1/-1;">
                            <label for="certificadoSAML" class="required">Certificado SAML (Certificado Público del IdP)</label>
                            <textarea id="certificadoSAML" rows="8" placeholder="-----BEGIN CERTIFICATE-----&#10;MIIDXTCCAkWgAwIBAgIJAKL0UG...&#10;-----END CERTIFICATE-----"
                                oninput="validateCertificate()" required style="font-family: monospace; font-size: 12px;"></textarea>
                            <div class="helper-text" id="certificadoHelper">Pegue el certificado X.509 público de su Identity Provider</div>
                        </div>
                    </div>

                    <!-- Duración de Sesión -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="duracionSesion" class="required">Duración de Sesión (Token JWT)</label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="number" id="duracionSesion" value="4" min="1" max="24" required
                                    oninput="validateDuracion()" style="flex: 0.3;" />
                                <span style="color: #757575;">horas</span>
                            </div>
                            <div class="helper-text" id="duracionHelper">Valor entre 1 y 24 horas (por defecto: 4 horas)</div>
                        </div>
                    </div>

                    <!-- Botón Guardar Configuración SCIM -->
                    <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #E0E0E0;">
                        <button type="button" class="btn btn-primary" onclick="saveScimConfig()" id="saveScimBtn" disabled>
                            <span class="material-icons" style="font-size: 18px; vertical-align: middle;">save</span>
                            Guardar Configuración SCIM
                        </button>
                    </div>
                </div>
                </div>
            </div>

            <!-- Sección 5: Productos -->
            <div class="section">
                <h2 class="section-title" onclick="toggleSection(this)">
                    <span class="material-icons">inventory_2</span>
                    Productos
                    <span class="material-icons collapse-icon">expand_more</span>
                </h2>

                <div class="section-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <p style="color: #757575; margin: 0;">Gestione los productos de la empresa</p>
                        <button type="button" class="btn btn-primary btn-small" onclick="openProductModal('add')">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle;">add</span>
                            Agregar Producto
                        </button>
                    </div>

                    <!-- Mensaje cuando no hay productos -->
                    <div id="noProductsMessage" style="text-align: center; padding: 48px 24px; background-color: #FAFAFA; border-radius: 8px; border: 1px dashed #BDBDBD;">
                        <span class="material-icons" style="font-size: 64px; color: #BDBDBD;">inventory_2</span>
                        <p style="color: #757575; margin: 16px 0 0 0; font-size: 16px;">No hay productos registrados</p>
                        <p style="color: #9E9E9E; margin: 8px 0 0 0; font-size: 14px;">Haga clic en "Agregar Producto" para crear el primer producto</p>
                    </div>

                    <!-- Tabla de productos -->
                    <div id="productsTableContainer" style="display: none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Descripción</th>
                                    <th style="text-align: center; width: 100px;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody"></tbody>
                        </table>

                        <!-- Paginación -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid #E0E0E0;">
                            <div style="color: #757575; font-size: 14px;" id="paginationInfo"></div>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" class="btn btn-secondary btn-small" onclick="changePage(-1)" id="prevPageBtn" disabled>
                                    <span class="material-icons" style="font-size: 16px;">chevron_left</span>
                                </button>
                                <button type="button" class="btn btn-secondary btn-small" onclick="changePage(1)" id="nextPageBtn" disabled>
                                    <span class="material-icons" style="font-size: 16px;">chevron_right</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="handleCancel()">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="submitBtn" disabled>Crear Empresa</button>
            </div>
        </form>
    </div>

    <!-- Modal de Producto -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <span class="material-icons">inventory_2</span>
                    <span id="modalTitle">Agregar Producto</span>
                </h2>
                <span class="close-modal" onclick="closeProductModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productIndex" value="-1">

                    <div class="form-row">
                        <div class="form-group" style="grid-column: 1/-1;">
                            <label for="productNombre" class="required">Nombre</label>
                            <input type="text" id="productNombre" placeholder="Nombre del producto" maxlength="100" required />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="grid-column: 1/-1;">
                            <label for="productDescripcion">Descripción</label>
                            <textarea id="productDescripcion" rows="3" placeholder="Descripción del producto" maxlength="200"></textarea>
                            <div class="character-counter" id="descripcionCounter">0/200 caracteres</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()" id="saveProductBtn">
                    <span class="material-icons" style="font-size: 16px; vertical-align: middle;">save</span>
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Datos mock
        const departamentos = {
            '1': [{code: '14', name: 'Cundinamarca'}, {code: '2', name: 'Antioquia'}]
        };
        const ciudades = {
            '14': [{code: '1', name: 'Bogotá D.C.'}],
            '2': [{code: '1', name: 'Medellín'}]
        };
        const centrosCostos = [];
        const registrosMercantiles = [];

        // Algoritmo DV DIAN
        function calcularDV(nit) {
            const multiplicadores = [3, 7, 13, 17, 19, 23, 29, 37, 41, 43, 47, 53, 59, 67, 71];
            const nitArray = nit.split('').reverse();
            let suma = 0;
            for (let i = 0; i < nitArray.length; i++) {
                suma += parseInt(nitArray[i]) * multiplicadores[i];
            }
            const residuo = suma % 11;
            return residuo > 1 ? 11 - residuo : residuo;
        }

        function validateDV() {
            const numeroId = document.getElementById('numeroId').value;
            const dv = document.getElementById('dv').value;
            const helper = document.getElementById('dvHelper');

            if (!numeroId || !dv) return;

            const dvCorrecto = calcularDV(numeroId);
            if (parseInt(dv) === dvCorrecto) {
                document.getElementById('dv').classList.remove('error');
                document.getElementById('dv').classList.add('success');
                helper.className = 'helper-text success';
                helper.innerHTML = '<span class="material-icons" style="font-size:16px;">check_circle</span> DV correcto';
            } else {
                document.getElementById('dv').classList.add('error');
                document.getElementById('dv').classList.remove('success');
                helper.className = 'helper-text error';
                helper.textContent = `DV incorrecto. El DV correcto es: ${dvCorrecto}`;
            }
        }

        function validateNumeroId() {
            const input = document.getElementById('numeroId');
            input.value = input.value.replace(/\D/g, '');
        }

        function checkUniqueness() {
            const numeroId = document.getElementById('numeroId').value;
            const helper = document.getElementById('numeroIdHelper');

            if (!numeroId) return;

            // Simulación de validación
            if (numeroId === '900123456') {
                document.getElementById('numeroId').classList.add('error');
                helper.className = 'helper-text error';
                helper.textContent = 'Este número de identificación ya existe en el sistema.';
            } else {
                document.getElementById('numeroId').classList.remove('error');
                document.getElementById('numeroId').classList.add('success');
                helper.className = 'helper-text success';
                helper.innerHTML = '<span class="material-icons" style="font-size:16px;">check_circle</span> NIT disponible';
            }
        }

        function validateEmail() {
            const input = document.getElementById('correoEmisor');
            const helper = document.getElementById('correoHelper');
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!input.value) return;

            if (regex.test(input.value)) {
                input.classList.remove('error');
                input.classList.add('success');
                helper.className = 'helper-text success';
                helper.innerHTML = '<span class="material-icons" style="font-size:16px;">check_circle</span> Email válido';
            } else {
                input.classList.add('error');
                helper.className = 'helper-text error';
                helper.textContent = 'Ingrese un correo electrónico válido';
            }
        }

        function handleTipoIdChange() {
            const tipoId = document.getElementById('tipoId').value;
            const esNIT = tipoId === '31';

            document.getElementById('razonSocialGroup').style.display = esNIT ? 'flex' : 'none';
            document.getElementById('razonSocial').disabled = !esNIT;

            document.getElementById('nombresGroup').style.display = !esNIT ? 'flex' : 'none';
            document.getElementById('nombres').disabled = esNIT;

            document.getElementById('apellidosGroup').style.display = !esNIT ? 'flex' : 'none';
            document.getElementById('apellidos').disabled = esNIT;
        }

        function handlePaisChange() {
            const pais = document.getElementById('pais').value;
            const esColombia = pais === '1';

            const deptoSelect = document.getElementById('departamento');
            const ciudadSelect = document.getElementById('ciudad');

            if (esColombia) {
                deptoSelect.disabled = false;
                deptoSelect.innerHTML = '<option value="">Seleccione...</option>';
                departamentos[pais].forEach(d => {
                    deptoSelect.innerHTML += `<option value="${d.code}">${d.name}</option>`;
                });
                document.getElementById('departamentoLabel').classList.add('required');
                document.getElementById('ciudadLabel').classList.add('required');
            } else {
                deptoSelect.disabled = true;
                ciudadSelect.disabled = true;
                deptoSelect.innerHTML = '<option value="">Seleccione...</option>';
                ciudadSelect.innerHTML = '<option value="">Seleccione...</option>';
                document.getElementById('departamentoLabel').classList.remove('required');
                document.getElementById('ciudadLabel').classList.remove('required');
            }
        }

        function handleDepartamentoChange() {
            const depto = document.getElementById('departamento').value;
            const ciudadSelect = document.getElementById('ciudad');

            if (depto && ciudades[depto]) {
                ciudadSelect.disabled = false;
                ciudadSelect.innerHTML = '<option value="">Seleccione...</option>';
                ciudades[depto].forEach(c => {
                    ciudadSelect.innerHTML += `<option value="${c.code}">${c.name}</option>`;
                });
            } else {
                ciudadSelect.disabled = true;
                ciudadSelect.innerHTML = '<option value="">Seleccione...</option>';
            }
        }

        function handlePaisRegistroChange() {
            const pais = document.getElementById('paisRegistro').value;
            const esColombia = pais === '1';
            const deptoSelect = document.getElementById('departamentoRegistro');

            if (esColombia) {
                deptoSelect.disabled = false;
                deptoSelect.innerHTML = '<option value="">Seleccione...</option>';
                departamentos[pais].forEach(d => {
                    deptoSelect.innerHTML += `<option value="${d.code}">${d.name}</option>`;
                });
            } else {
                deptoSelect.disabled = true;
                deptoSelect.innerHTML = '<option value="">Seleccione...</option>';
            }
        }

        function handleDepartamentoRegistroChange() {
            const depto = document.getElementById('departamentoRegistro').value;
            const ciudadSelect = document.getElementById('ciudadRegistro');

            if (depto && ciudades[depto]) {
                ciudadSelect.disabled = false;
                ciudadSelect.innerHTML = '<option value="">Seleccione...</option>';
                ciudades[depto].forEach(c => {
                    ciudadSelect.innerHTML += `<option value="${c.code}">${c.name}</option>`;
                });
            } else {
                ciudadSelect.disabled = true;
            }
        }

        function updateCounter(fieldId, max) {
            const field = document.getElementById(fieldId);
            const counter = document.getElementById(fieldId + 'Counter');
            counter.textContent = `${field.value.length}/${max} caracteres`;
        }

        function addCentroCosto() {
            const input = document.getElementById('centroCostoInput');
            const value = input.value.trim();

            if (!/^\d{1,5}$/.test(value)) {
                alert('Ingrese un valor numérico de hasta 5 dígitos');
                return;
            }

            centrosCostos.push(value);
            const table = document.getElementById('centrosCostosTable');
            const tbody = document.getElementById('centrosCostosBody');

            tbody.innerHTML += `<tr><td>${value}</td><td><button type="button" class="icon-btn" onclick="removeCentroCosto(${centrosCostos.length-1})"><span class="material-icons">delete</span></button></td></tr>`;
            table.style.display = 'table';
            input.value = '';
        }

        function removeCentroCosto(index) {
            if (confirm(`¿Eliminar Centro de Costos ${centrosCostos[index]}?`)) {
                centrosCostos.splice(index, 1);
                refreshCentrosCostosTable();
            }
        }

        function refreshCentrosCostosTable() {
            const tbody = document.getElementById('centrosCostosBody');
            tbody.innerHTML = '';
            centrosCostos.forEach((cc, i) => {
                tbody.innerHTML += `<tr><td>${cc}</td><td><button type="button" class="icon-btn" onclick="removeCentroCosto(${i})"><span class="material-icons">delete</span></button></td></tr>`;
            });
        }

        function addRegistroMercantil() {
            const matricula = document.getElementById('matriculaMercantil').value;
            const nombre = document.getElementById('nombreRegistro').value;
            const pais = document.getElementById('paisRegistro').options[document.getElementById('paisRegistro').selectedIndex].text;
            const direccion = document.getElementById('direccionRegistro').value;

            if (!matricula || !nombre || !pais || !direccion) {
                alert('Complete todos los campos obligatorios del Registro Mercantil');
                return;
            }

            registrosMercantiles.push({matricula, nombre, pais, direccion});
            const table = document.getElementById('registrosMercantilesTable');
            const tbody = document.getElementById('registrosMercantilesBody');

            tbody.innerHTML += `<tr><td>${matricula}</td><td>${nombre}</td><td>${pais}</td><td>${direccion}</td><td><button type="button" class="icon-btn" onclick="removeRegistro(${registrosMercantiles.length-1})"><span class="material-icons">delete</span></button></td></tr>`;
            table.style.display = 'table';

            // Limpiar formulario
            document.getElementById('matriculaMercantil').value = '';
            document.getElementById('nombreRegistro').value = '';
            document.getElementById('paisRegistro').value = '';
            document.getElementById('direccionRegistro').value = '';
        }

        function removeRegistro(index) {
            if (confirm(`¿Eliminar Registro Mercantil ${registrosMercantiles[index].matricula}?`)) {
                registrosMercantiles.splice(index, 1);
                refreshRegistrosTable();
            }
        }

        function refreshRegistrosTable() {
            const tbody = document.getElementById('registrosMercantilesBody');
            tbody.innerHTML = '';
            registrosMercantiles.forEach((r, i) => {
                tbody.innerHTML += `<tr><td>${r.matricula}</td><td>${r.nombre}</td><td>${r.pais}</td><td>${r.direccion}</td><td><button type="button" class="icon-btn" onclick="removeRegistro(${i})"><span class="material-icons">delete</span></button></td></tr>`;
            });
        }

        function handleCancel() {
            if (confirm('¿Está seguro que desea cancelar? Se perderán todos los datos ingresados.')) {
                alert('Cancelando...');
            }
        }

        document.getElementById('empresaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Esta es una demostración. En producción, mostraría la pantalla de resumen.');
        });

        // Habilitar botón submit cuando campos obligatorios estén completos
        setInterval(() => {
            const numeroId = document.getElementById('numeroId').value;
            const tipoId = document.getElementById('tipoId').value;
            document.getElementById('submitBtn').disabled = !numeroId || !tipoId;
        }, 500);

        // ========== FUNCIONES DE COLAPSO DE SECCIONES ==========

        function toggleSection(titleElement) {
            const contentDiv = titleElement.nextElementSibling;
            const icon = titleElement.querySelector('.collapse-icon');

            if (contentDiv.classList.contains('collapsed')) {
                // Expandir
                contentDiv.style.maxHeight = contentDiv.scrollHeight + 'px';
                contentDiv.classList.remove('collapsed');
                icon.classList.remove('collapsed');
            } else {
                // Colapsar
                contentDiv.style.maxHeight = contentDiv.scrollHeight + 'px';
                // Forzar reflow
                contentDiv.offsetHeight;
                contentDiv.style.maxHeight = '0px';
                contentDiv.classList.add('collapsed');
                icon.classList.add('collapsed');
            }
        }

        // Inicializar altura máxima de las secciones al cargar
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.section-content').forEach(content => {
                if (!content.classList.contains('collapsed')) {
                    content.style.maxHeight = content.scrollHeight + 'px';
                }
            });

            // Event listeners para validación SCIM
            document.getElementById('urlIdpSAML')?.addEventListener('blur', validateURL);
            document.getElementById('certificadoSAML')?.addEventListener('blur', validateCertificate);
            document.getElementById('duracionSesion')?.addEventListener('blur', validateDuracion);
        });

        // ========== FUNCIONES SCIM ==========

        let tokenVisible = false;
        let currentToken = '';

        function handleSCIMToggle() {
            const checkbox = document.getElementById('scimActivo');
            const configSection = document.getElementById('scimConfigSection');

            if (checkbox.checked) {
                // Generar token automáticamente al activar
                generateInitialToken();
                configSection.style.display = 'block';

                // Simular actualización del endpoint con tenantId real
                const tenantId = 'TENANT' + Math.floor(Math.random() * 10000);
                document.getElementById('endpointSCIM').value = `https://plataforma.com/scim/v2/${tenantId}/Users`;

                // Recalcular altura de la sección padre
                updateSectionHeight(checkbox);
            } else {
                configSection.style.display = 'none';
                if (!confirm('¿Está seguro que desea desactivar la integración SCIM? Esto puede afectar la sincronización de usuarios.')) {
                    checkbox.checked = true;
                    configSection.style.display = 'block';
                } else {
                    // Recalcular altura de la sección padre
                    updateSectionHeight(checkbox);
                }
            }
        }

        function updateSectionHeight(element) {
            // Encontrar la sección-content padre más cercana
            let sectionContent = element.closest('.section-content');
            if (sectionContent && !sectionContent.classList.contains('collapsed')) {
                // Pequeño delay para que el DOM se actualice
                setTimeout(() => {
                    sectionContent.style.maxHeight = sectionContent.scrollHeight + 'px';
                }, 10);
            }
        }

        function generateInitialToken() {
            // Generar token aleatorio de 32 caracteres
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let token = '';
            for (let i = 0; i < 32; i++) {
                token += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            currentToken = token;
            document.getElementById('bearerToken').value = token;

            // Establecer fecha de expiración (90 días)
            const expDate = new Date();
            expDate.setDate(expDate.getDate() + 90);
            document.getElementById('fechaExpiracion').value = expDate.toLocaleString('es-CO');
            document.getElementById('expiracionHelper').textContent = 'El token expirará en 90 días';
            document.getElementById('expiracionHelper').style.color = '#4CAF50';
        }

        function toggleTokenVisibility() {
            const tokenInput = document.getElementById('bearerToken');
            const icon = document.getElementById('tokenVisibilityIcon');

            tokenVisible = !tokenVisible;
            tokenInput.type = tokenVisible ? 'text' : 'password';
            icon.textContent = tokenVisible ? 'visibility_off' : 'visibility';
        }

        function copyToClipboard(fieldId) {
            const input = document.getElementById(fieldId);
            input.select();
            input.setSelectionRange(0, 99999); // Para móviles

            try {
                navigator.clipboard.writeText(input.value).then(() => {
                    // Mostrar feedback visual
                    const originalBg = input.style.backgroundColor;
                    input.style.backgroundColor = '#E8F5E9';
                    setTimeout(() => {
                        input.style.backgroundColor = originalBg;
                    }, 500);
                    alert('Copiado al portapapeles');
                });
            } catch (err) {
                alert('No se pudo copiar. Por favor, copie manualmente.');
            }
        }

        function regenerateToken() {
            if (!confirm('¿Está seguro que desea regenerar el token? El token anterior dejará de funcionar y deberá actualizar la configuración en su Identity Provider.')) {
                return;
            }

            generateInitialToken();
            alert('Token regenerado exitosamente. Asegúrese de actualizar la configuración en su Identity Provider.');

            // El token anterior se guarda en historial (simulación)
            console.log('Token anterior guardado en historial:', currentToken);
        }

        function validateURL() {
            const input = document.getElementById('urlIdpSAML');
            const helper = document.getElementById('urlIdpHelper');
            const url = input.value.trim();

            if (!url) {
                input.classList.remove('error', 'success');
                helper.className = 'helper-text';
                helper.textContent = 'Ingrese la URL HTTPS de su Identity Provider SAML';
                return;
            }

            // Validar que comience con https://
            if (!url.startsWith('https://')) {
                input.classList.add('error');
                input.classList.remove('success');
                helper.className = 'helper-text error';
                helper.textContent = 'Ingrese una URL HTTPS válida del Identity Provider';
                return;
            }

            // Validar formato de URL
            try {
                new URL(url);
                input.classList.remove('error');
                input.classList.add('success');
                helper.className = 'helper-text success';
                helper.innerHTML = '<span class="material-icons" style="font-size:16px;">check_circle</span> URL válida';
            } catch (e) {
                input.classList.add('error');
                input.classList.remove('success');
                helper.className = 'helper-text error';
                helper.textContent = 'Formato de URL inválido';
            }

            checkScimFormValidity();
        }

        function validateCertificate() {
            const input = document.getElementById('certificadoSAML');
            const helper = document.getElementById('certificadoHelper');
            const cert = input.value.trim();

            if (!cert) {
                input.classList.remove('error', 'success');
                helper.className = 'helper-text';
                helper.textContent = 'Pegue el certificado X.509 público de su Identity Provider';
                return;
            }

            // Validar que contenga BEGIN y END CERTIFICATE
            if (!cert.includes('-----BEGIN CERTIFICATE-----') || !cert.includes('-----END CERTIFICATE-----')) {
                input.classList.add('error');
                input.classList.remove('success');
                helper.className = 'helper-text error';
                helper.textContent = 'Certificado SAML no válido. Debe contener los bloques BEGIN/END CERTIFICATE';
                return;
            }

            // Validación simplificada de formato base64
            const certContent = cert.replace('-----BEGIN CERTIFICATE-----', '')
                                   .replace('-----END CERTIFICATE-----', '')
                                   .replace(/\s/g, '');

            const base64Regex = /^[A-Za-z0-9+/=]+$/;
            if (!base64Regex.test(certContent)) {
                input.classList.add('error');
                input.classList.remove('success');
                helper.className = 'helper-text error';
                helper.textContent = 'El contenido del certificado no es válido';
                return;
            }

            input.classList.remove('error');
            input.classList.add('success');
            helper.className = 'helper-text success';
            helper.innerHTML = '<span class="material-icons" style="font-size:16px;">check_circle</span> Certificado válido';

            checkScimFormValidity();
        }

        function validateDuracion() {
            const input = document.getElementById('duracionSesion');
            const helper = document.getElementById('duracionHelper');
            const valor = parseInt(input.value);

            if (isNaN(valor) || valor < 1 || valor > 24) {
                input.classList.add('error');
                input.classList.remove('success');
                helper.className = 'helper-text error';
                helper.textContent = 'La duración debe estar entre 1 y 24 horas';
                return;
            }

            input.classList.remove('error');
            input.classList.add('success');
            helper.className = 'helper-text';
            helper.textContent = `Duración configurada: ${valor} hora${valor > 1 ? 's' : ''}`;

            checkScimFormValidity();
        }

        function checkScimFormValidity() {
            const urlValida = document.getElementById('urlIdpSAML').classList.contains('success');
            const certValido = document.getElementById('certificadoSAML').classList.contains('success');
            const duracionValida = document.getElementById('duracionSesion').classList.contains('success');
            const scimActivo = document.getElementById('scimActivo').checked;

            const saveBtn = document.getElementById('saveScimBtn');
            saveBtn.disabled = !(scimActivo && urlValida && certValido && duracionValida);
        }

        function saveScimConfig() {
            const config = {
                scimActivo: document.getElementById('scimActivo').checked,
                endpoint: document.getElementById('endpointSCIM').value,
                bearerToken: currentToken,
                fechaExpiracion: document.getElementById('fechaExpiracion').value,
                urlIdp: document.getElementById('urlIdpSAML').value,
                certificado: document.getElementById('certificadoSAML').value,
                duracionSesion: document.getElementById('duracionSesion').value
            };

            console.log('Configuración SCIM a guardar:', config);

            // Simulación de guardado exitoso
            alert('Configuración SCIM guardada exitosamente.\n\n' +
                  'Endpoint: ' + config.endpoint + '\n' +
                  'Token generado: ' + config.bearerToken.substring(0, 10) + '...\n' +
                  'Duración de sesión: ' + config.duracionSesion + ' horas\n\n' +
                  'Configure estos valores en su Identity Provider.');

            // Ocultar token después del primer guardado (simulación)
            setTimeout(() => {
                document.getElementById('bearerToken').type = 'password';
                tokenVisible = false;
                document.getElementById('tokenVisibilityIcon').textContent = 'visibility';
            }, 3000);
        }

        // ========== FUNCIONES DE PRODUCTOS ==========

        let productos = [];
        let currentPage = 1;
        const productsPerPage = 5;
        let editingProductIndex = -1;

        // Cargar algunos productos de ejemplo (puedes comentar esto para empezar sin productos)
        // productos = [
        //     { nombre: 'Servicio de Consultoría', descripcion: 'Consultoría especializada en tecnología' },
        //     { nombre: 'Licencia Software Anual', descripcion: 'Licencia de uso del software por un año' },
        //     { nombre: 'Soporte Técnico Premium', descripcion: 'Soporte técnico 24/7' }
        // ];

        function openProductModal(mode, index = -1) {
            const modal = document.getElementById('productModal');
            const modalTitle = document.getElementById('modalTitle');
            const form = document.getElementById('productForm');

            // Resetear formulario
            form.reset();
            document.getElementById('descripcionCounter').textContent = '0/200 caracteres';

            if (mode === 'add') {
                modalTitle.textContent = 'Agregar Producto';
                editingProductIndex = -1;
                document.getElementById('productIndex').value = '-1';
            } else if (mode === 'edit' && index >= 0) {
                modalTitle.textContent = 'Editar Producto';
                editingProductIndex = index;
                document.getElementById('productIndex').value = index;

                // Cargar datos del producto
                const product = productos[index];
                document.getElementById('productNombre').value = product.nombre;
                document.getElementById('productDescripcion').value = product.descripcion || '';

                // Actualizar contador
                const descLen = (product.descripcion || '').length;
                document.getElementById('descripcionCounter').textContent = `${descLen}/200 caracteres`;
            }

            modal.style.display = 'block';
        }

        function closeProductModal() {
            const modal = document.getElementById('productModal');
            modal.style.display = 'none';
            editingProductIndex = -1;
        }

        // Cerrar modal al hacer clic fuera de él
        window.onclick = function(event) {
            const modal = document.getElementById('productModal');
            if (event.target === modal) {
                closeProductModal();
            }
        }

        function saveProduct() {
            const nombre = document.getElementById('productNombre').value.trim();
            const descripcion = document.getElementById('productDescripcion').value.trim();

            // Validaciones básicas
            if (!nombre) {
                alert('Por favor ingrese el nombre del producto');
                return;
            }

            const producto = {
                nombre: nombre,
                descripcion: descripcion
            };

            if (editingProductIndex >= 0) {
                // Editar producto existente
                productos[editingProductIndex] = producto;
                alert('Producto actualizado correctamente');
            } else {
                // Agregar nuevo producto
                productos.push(producto);
                alert('Producto agregado correctamente');
            }

            closeProductModal();
            renderProductsTable();

            // Recalcular altura de la sección
            const sectionContent = document.querySelector('#productsTableContainer').closest('.section-content');
            if (sectionContent && !sectionContent.classList.contains('collapsed')) {
                setTimeout(() => {
                    sectionContent.style.maxHeight = sectionContent.scrollHeight + 'px';
                }, 10);
            }
        }

        function deleteProduct(index) {
            const product = productos[index];
            if (confirm(`¿Está seguro que desea eliminar el producto "${product.nombre}"?`)) {
                productos.splice(index, 1);

                // Ajustar página actual si es necesario
                const totalPages = Math.ceil(productos.length / productsPerPage);
                if (currentPage > totalPages && currentPage > 1) {
                    currentPage = totalPages;
                }

                renderProductsTable();
                alert('Producto eliminado correctamente');
            }
        }

        function renderProductsTable() {
            const noProductsMsg = document.getElementById('noProductsMessage');
            const tableContainer = document.getElementById('productsTableContainer');
            const tbody = document.getElementById('productsTableBody');

            if (productos.length === 0) {
                noProductsMsg.style.display = 'block';
                tableContainer.style.display = 'none';
                return;
            }

            noProductsMsg.style.display = 'none';
            tableContainer.style.display = 'block';

            // Calcular paginación
            const totalPages = Math.ceil(productos.length / productsPerPage);
            const startIndex = (currentPage - 1) * productsPerPage;
            const endIndex = Math.min(startIndex + productsPerPage, productos.length);
            const currentProducts = productos.slice(startIndex, endIndex);

            // Renderizar filas
            tbody.innerHTML = '';
            currentProducts.forEach((product, idx) => {
                const realIndex = startIndex + idx;
                const row = `
                    <tr>
                        <td><strong>${product.nombre}</strong></td>
                        <td>${product.descripcion || '<span style="color: #9E9E9E;">Sin descripción</span>'}</td>
                        <td style="text-align: center;">
                            <button type="button" class="icon-btn" onclick="openProductModal('edit', ${realIndex})" title="Editar producto" style="color: #4A5A9E;">
                                <span class="material-icons">edit</span>
                            </button>
                            <button type="button" class="icon-btn" onclick="deleteProduct(${realIndex})" title="Eliminar producto">
                                <span class="material-icons">delete</span>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Actualizar información de paginación
            document.getElementById('paginationInfo').textContent =
                `Mostrando ${startIndex + 1}-${endIndex} de ${productos.length} productos`;

            // Actualizar botones de paginación
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(productos.length / productsPerPage);
            currentPage += direction;

            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;

            renderProductsTable();
        }

        // Event listener para contador de caracteres en descripción del producto
        document.addEventListener('DOMContentLoaded', function() {
            // Inicialización existente...
            document.querySelectorAll('.section-content').forEach(content => {
                if (!content.classList.contains('collapsed')) {
                    content.style.maxHeight = content.scrollHeight + 'px';
                }
            });

            // Event listeners para validación SCIM
            document.getElementById('urlIdpSAML')?.addEventListener('blur', validateURL);
            document.getElementById('certificadoSAML')?.addEventListener('blur', validateCertificate);
            document.getElementById('duracionSesion')?.addEventListener('blur', validateDuracion);

            // Event listeners para productos
            document.getElementById('productDescripcion')?.addEventListener('input', function() {
                const counter = document.getElementById('descripcionCounter');
                counter.textContent = `${this.value.length}/200 caracteres`;
            });

            // Renderizar tabla inicial
            renderProductsTable();
        });
    </script>
</body>
</html>
